From 027557f5d2114ee79c6609d3c53b25a6492af2be Mon Sep 17 00:00:00 2001
From: "Chris \"Koying\" Browet" <cbro@semperpax.com>
Date: Sun, 27 Mar 2016 16:36:42 +0200
Subject: [PATCH] FIX: speedup thumb loading

---
 xbmc/video/VideoThumbLoader.cpp | 26 +++++++++++++++++++++++---
 1 file changed, 23 insertions(+), 3 deletions(-)

diff --git a/xbmc/video/VideoThumbLoader.cpp b/xbmc/video/VideoThumbLoader.cpp
index d94998df2f..19b5bf47d7 100644
--- a/xbmc/video/VideoThumbLoader.cpp
+++ b/xbmc/video/VideoThumbLoader.cpp
@@ -19,6 +19,8 @@
 #include "filesystem/DirectoryCache.h"
 #include "filesystem/StackDirectory.h"
 #include "guilib/GUIComponent.h"
+#include "filesystem/File.h"
+#include "filesystem/CurlFile.h"
 #include "guilib/GUIWindowManager.h"
 #include "guilib/StereoscopicsManager.h"
 #include "music/MusicDatabase.h"
@@ -437,10 +439,28 @@ bool CVideoThumbLoader::LoadItemLookup(CFileItem* pItem)
   // We can only extract flags/thumbs for file-like items
   if (!pItem->m_bIsFolder && pItem->IsVideo())
   {
-    // An auto-generated thumb may have been cached on a different device - check we have it here
     std::string url = pItem->GetArt("thumb");
-    if (StringUtils::StartsWith(url, "image://video@") && !CTextureCache::GetInstance().HasCachedImage(url))
-      pItem->SetArt("thumb", "");
+    if (!CTextureCache::GetInstance().HasCachedImage(url))
+    {
+      // An auto-generated thumb may have been cached on a different device - check we have it here
+      if (StringUtils::StartsWith(url, "image://video@"))
+        pItem->SetArt("thumb", "");
+
+      // Check invalid redirections
+      else if (URIUtils::IsInternetStream(url))
+      {
+        std::string mimetype;
+        bool valid = XFILE::CCurlFile::GetMimeType(CURL(url), mimetype);
+        if (valid && !StringUtils::StartsWith(mimetype, "image/"))
+          valid = false;
+        if (!valid)
+          pItem->SetArt("thumb", "");
+      }
+
+      // Check if thumb source still exists
+      else if (!XFILE::CFile::Exists(url))
+        pItem->SetArt("thumb", "");
+    }
 
     const std::shared_ptr<CSettings> settings = CServiceBroker::GetSettingsComponent()->GetSettings();
     if (!pItem->HasArt("thumb"))
