From 9b4bc2ecd69e478c88eaf6b4300a23318334a7f2 Mon Sep 17 00:00:00 2001
From: Portisch <hugo.portisch@yahoo.de>
Date: Fri, 12 Apr 2019 08:00:34 +0000
Subject: [PATCH] LibInputHandler: add suspend mode support This will fix the
 61662 (0xf0de) ShutDown action on suspend resume

---
 xbmc/platform/linux/input/LibInputHandler.cpp | 20 +++++++++++++++++++
 xbmc/platform/linux/input/LibInputHandler.h   |  8 +++++++-
 2 files changed, 27 insertions(+), 1 deletion(-)

diff --git a/xbmc/platform/linux/input/LibInputHandler.cpp b/xbmc/platform/linux/input/LibInputHandler.cpp
index e2912ab6da4..0c4afdd137a 100644
--- a/xbmc/platform/linux/input/LibInputHandler.cpp
+++ b/xbmc/platform/linux/input/LibInputHandler.cpp
@@ -13,6 +13,8 @@
 #include "LibInputSettings.h"
 #include "LibInputTouch.h"
 #include "utils/log.h"
+#include "ServiceBroker.h"
+#include "interfaces/AnnouncementManager.h"
 
 #include <algorithm>
 #include <string.h>
@@ -93,16 +95,34 @@ CLibInputHandler::CLibInputHandler() : CThread("libinput")
   m_pointer.reset(new CLibInputPointer());
   m_touch.reset(new CLibInputTouch());
   m_settings.reset(new CLibInputSettings(this));
+
+  CServiceBroker::GetAnnouncementManager()->AddAnnouncer(this);
 }
 
 CLibInputHandler::~CLibInputHandler()
 {
+  CServiceBroker::GetAnnouncementManager()->RemoveAnnouncer(this);
   StopThread();
 
   libinput_unref(m_li);
   udev_unref(m_udev);
 }
 
+void CLibInputHandler::Announce(ANNOUNCEMENT::AnnouncementFlag flag, const std::string& sender, const std::string& message, const CVariant& data)
+{
+  if ((flag & (ANNOUNCEMENT::System)))
+  {
+    if (StringUtils::EqualsNoCase(message, "OnSleep"))
+      libinput_suspend(m_li);
+    else if (StringUtils::EqualsNoCase(message, "OnWake"))
+    {
+      auto ret = libinput_resume(m_li);
+      if (ret < 0)
+        CLog::Log(LOGERROR, "CLibInputHandler::%s - failed to resume monitoring", __FUNCTION__);
+    }
+  }
+}
+
 bool CLibInputHandler::SetKeymap(const std::string& layout)
 {
   return m_keyboard->SetKeymap(layout);
diff --git a/xbmc/platform/linux/input/LibInputHandler.h b/xbmc/platform/linux/input/LibInputHandler.h
index 202330cb303..89c8f992aff 100644
--- a/xbmc/platform/linux/input/LibInputHandler.h
+++ b/xbmc/platform/linux/input/LibInputHandler.h
@@ -9,6 +9,7 @@
 #pragma once
 
 #include "threads/Thread.h"
+#include "interfaces/IAnnouncer.h"
 
 #include <memory>
 #include <vector>
@@ -21,12 +22,17 @@ class CLibInputPointer;
 class CLibInputSettings;
 class CLibInputTouch;
 
-class CLibInputHandler : CThread
+class CLibInputHandler : CThread, public ANNOUNCEMENT::IAnnouncer
 {
 public:
   CLibInputHandler();
   ~CLibInputHandler() override;
 
+  void Announce(ANNOUNCEMENT::AnnouncementFlag flag,
+              const std::string& sender,
+              const std::string& message,
+              const CVariant& data) override;
+
   void Start();
 
   bool SetKeymap(const std::string& layout);
