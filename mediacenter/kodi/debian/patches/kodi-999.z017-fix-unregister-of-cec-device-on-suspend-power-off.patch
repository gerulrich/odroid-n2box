From ba576157616094bc6d3f9573f6c4b8a3ab9fcc3b Mon Sep 17 00:00:00 2001
From: Portisch <hugo.portisch@yahoo.de>
Date: Wed, 5 Jun 2019 10:32:35 +0000
Subject: [PATCH] PeripheralCecAdapter: fix unregister of cec device on
 suspend/power off

---
 .../devices/PeripheralCecAdapter.cpp          | 75 ++++++++++---------
 .../devices/PeripheralCecAdapter.h            |  1 +
 2 files changed, 41 insertions(+), 35 deletions(-)

diff --git a/xbmc/peripherals/devices/PeripheralCecAdapter.cpp b/xbmc/peripherals/devices/PeripheralCecAdapter.cpp
index d1ed1cfc987..e7dcca4be2b 100644
--- a/xbmc/peripherals/devices/PeripheralCecAdapter.cpp
+++ b/xbmc/peripherals/devices/PeripheralCecAdapter.cpp
@@ -174,7 +174,7 @@ void CPeripheralCecAdapter::Announce(ANNOUNCEMENT::AnnouncementFlag flag,
       CSingleLock lock(m_critSection);
       m_bGoingToStandby = true;
     }
-    StopThread();
+    UnregisterDevice();
   }
   else if (flag == ANNOUNCEMENT::System && sender == CAnnouncementManager::ANNOUNCEMENT_SENDER &&
            message == "OnWake")
@@ -381,40 +381,7 @@ void CPeripheralCecAdapter::Process(void)
 
   m_queryThread->StopThread(true);
 
-  bool bSendStandbyCommands(false);
-  {
-    CSingleLock lock(m_critSection);
-    bSendStandbyCommands = m_iExitCode != EXITCODE_REBOOT && m_iExitCode != EXITCODE_RESTARTAPP &&
-                           !m_bDeviceRemoved &&
-                           (!m_bGoingToStandby || GetSettingBool("standby_tv_on_pc_standby")) &&
-                           GetSettingBool("enabled");
-
-    if (m_bGoingToStandby)
-      m_bActiveSourceBeforeStandby = m_cecAdapter->IsLibCECActiveSource();
-  }
-
-  if (bSendStandbyCommands)
-  {
-    if (m_cecAdapter->IsLibCECActiveSource())
-    {
-      if (!m_configuration.powerOffDevices.IsEmpty())
-      {
-        CLog::Log(LOGDEBUG, "%s - sending standby commands", __FUNCTION__);
-        m_standbySent = CDateTime::GetCurrentDateTime();
-        m_cecAdapter->StandbyDevices();
-      }
-      else if (m_bSendInactiveSource)
-      {
-        CLog::Log(LOGDEBUG, "%s - sending inactive source commands", __FUNCTION__);
-        m_cecAdapter->SetInactiveView();
-      }
-    }
-    else
-    {
-      CLog::Log(LOGDEBUG, "%s - XBMC is not the active source, not sending any standby commands",
-                __FUNCTION__);
-    }
-  }
+  UnregisterDevice();
 
   m_cecAdapter->Close();
 
@@ -1773,6 +1740,44 @@ void CPeripheralCecAdapter::ProcessActivateSource(void)
     m_cecAdapter->SetActiveSource();
 }
 
+void CPeripheralCecAdapter::UnregisterDevice(void)
+{
+  bool bSendStandbyCommands(false);
+  {
+    CSingleLock lock(m_critSection);
+    bSendStandbyCommands = m_iExitCode != EXITCODE_REBOOT &&
+      m_iExitCode != EXITCODE_RESTARTAPP &&
+      !m_bDeviceRemoved &&
+      (!m_bGoingToStandby || GetSettingBool("standby_tv_on_pc_standby")) &&
+      GetSettingBool("enabled");
+
+    if (m_bGoingToStandby)
+      m_bActiveSourceBeforeStandby = m_cecAdapter->IsLibCECActiveSource();
+  }
+
+  if (bSendStandbyCommands)
+  {
+    if (m_cecAdapter->IsLibCECActiveSource())
+    {
+      if (!m_configuration.powerOffDevices.IsEmpty())
+      {
+        CLog::Log(LOGDEBUG, "%s - sending standby commands", __FUNCTION__);
+        m_standbySent = CDateTime::GetCurrentDateTime();
+        m_cecAdapter->StandbyDevices();
+      }
+      else if (m_bSendInactiveSource)
+      {
+        CLog::Log(LOGDEBUG, "%s - sending inactive source commands", __FUNCTION__);
+        m_cecAdapter->SetInactiveView();
+      }
+    }
+    else
+    {
+      CLog::Log(LOGDEBUG, "%s - XBMC is not the active source, not sending any standby commands", __FUNCTION__);
+    }
+  }
+}
+
 void CPeripheralCecAdapter::StandbyDevices(void)
 {
   CSingleLock lock(m_critSection);
diff --git a/xbmc/peripherals/devices/PeripheralCecAdapter.h b/xbmc/peripherals/devices/PeripheralCecAdapter.h
index 78ac76aeafe..808dd51d529 100644
--- a/xbmc/peripherals/devices/PeripheralCecAdapter.h
+++ b/xbmc/peripherals/devices/PeripheralCecAdapter.h
@@ -112,6 +112,7 @@ class CPeripheralCecAdapter : public CPeripheralHID,
 
   // public CEC methods
   void ActivateSource(void);
+  void UnregisterDevice(void);
   void StandbyDevices(void);
   bool ToggleDeviceState(CecStateChange mode = STATE_SWITCH_TOGGLE, bool forceType = false);
 
