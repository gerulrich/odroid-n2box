From 3acb4aa72c5d3bf502df170518d1bdf2de35e47c Mon Sep 17 00:00:00 2001
From: adamg <adamg88@users.noreply.github.com>
Date: Wed, 10 Apr 2019 14:43:00 +0100
Subject: [PATCH] Add Amlogic specific settings menu

---
 .../resources/strings.po                      | 32 ++++++++++++++++++-
 system/settings/settings.xml                  | 22 +++++++++++++
 xbmc/settings/Settings.cpp                    |  2 ++
 xbmc/settings/Settings.h                      |  2 ++
 xbmc/windowing/amlogic/WinSystemAmlogic.cpp   | 15 +++++++++
 5 files changed, 72 insertions(+), 1 deletion(-)

diff --git a/addons/resource.language.en_gb/resources/strings.po b/addons/resource.language.en_gb/resources/strings.po
index 8282ec387fd..fec53f058b1 100644
--- a/addons/resource.language.en_gb/resources/strings.po
+++ b/addons/resource.language.en_gb/resources/strings.po
@@ -8393,7 +8393,37 @@ msgctxt "#14277"
 msgid "Allow remote control from applications on other systems"
 msgstr ""
 
-#empty strings from id 14278 to 14300
+#: system/settings/settings.xml
+msgctxt "#14278"
+msgid "CoreELEC"
+msgstr ""
+
+#: system/settings/settings.xml
+msgctxt "#14279"
+msgid "This category contains settings added for CoreELEC."
+msgstr ""
+
+#: system/settings/settings.xml
+msgctxt "#14280"
+msgid "Disable noise reduction"
+msgstr ""
+
+#: system/settings/settings.xml
+msgctxt "#14281"
+msgid "Enable this to disable noise reduction. Requires reboot."
+msgstr ""
+
+#: system/settings/settings.xml
+msgctxt "#14282"
+msgid "Tone map SDR to HDR"
+msgstr ""
+
+#: system/settings/settings.xml
+msgctxt "#14283"
+msgid "Intended for HDR enabled displays - not recommended. Turn this On or set to Auto to have HDR10 mode always on. GUI and SDR content will be tone mapped. Requires reboot."
+msgstr ""
+
+#empty strings from id 14284 to 14300
 
 #. pvr "channels" settings group label
 #: system/settings/settings.xml
diff --git a/system/settings/settings.xml b/system/settings/settings.xml
index 1183228d5e8..146c3d721a6 100755
--- a/system/settings/settings.xml
+++ b/system/settings/settings.xml
@@ -3378,6 +3378,28 @@
         </setting>
       </group>
     </category>
+    <category id="coreelec" label="14278" help="14279">
+      <group id="1" label="131">
+        <setting id="coreelec.amlogic.noisereduction" type="boolean" label="14280" help="14281">
+          <requirement>HAVE_AMCODEC</requirement>
+          <level>3</level>
+          <default>false</default>
+          <control type="toggle" />
+        </setting>
+        <setting id="coreelec.amlogic.sdr2hdr" type="integer" label="14282" help="14283">
+          <requirement>HAVE_AMCODEC</requirement>
+          <default>0</default> <!-- OFF -->
+          <constraints>
+            <options>
+              <option label="351">0</option> <!-- OFF -->
+              <option label="16041">1</option> <!-- ON -->
+              <option label="16316">2</option> <!-- AUTO -->
+            </options>
+          </constraints>
+          <control type="list" format="string" />
+        </setting>
+      </group>
+    </category>
     <category id="cache" label="439" help="36399">
       <visible>false</visible>
       <group id="1">
diff --git a/xbmc/settings/Settings.cpp b/xbmc/settings/Settings.cpp
index ae194bfba9d..026cff0c605 100644
--- a/xbmc/settings/Settings.cpp
+++ b/xbmc/settings/Settings.cpp
@@ -414,6 +414,8 @@ constexpr const char* CSettings::SETTING_EVENTLOG_SHOW;
 constexpr const char* CSettings::SETTING_MASTERLOCK_LOCKCODE;
 constexpr const char* CSettings::SETTING_MASTERLOCK_STARTUPLOCK;
 constexpr const char* CSettings::SETTING_MASTERLOCK_MAXRETRIES;
+constexpr const char* CSettings::SETTING_COREELEC_AMLOGIC_NOISEREDUCTION;
+constexpr const char* CSettings::SETTING_COREELEC_AMLOGIC_SDR2HDR;
 constexpr const char* CSettings::SETTING_CACHE_HARDDISK;
 constexpr const char* CSettings::SETTING_CACHEVIDEO_DVDROM;
 constexpr const char* CSettings::SETTING_CACHEVIDEO_LAN;
diff --git a/xbmc/settings/Settings.h b/xbmc/settings/Settings.h
index cf9ecea9e38..ead8ab07e97 100644
--- a/xbmc/settings/Settings.h
+++ b/xbmc/settings/Settings.h
@@ -414,6 +414,8 @@ class CSettings : public CSettingsBase, public CSettingCreator, public CSettingC
   static constexpr auto SETTING_MASTERLOCK_LOCKCODE = "masterlock.lockcode";
   static constexpr auto SETTING_MASTERLOCK_STARTUPLOCK = "masterlock.startuplock";
   static constexpr auto SETTING_MASTERLOCK_MAXRETRIES = "masterlock.maxretries";
+  static constexpr auto SETTING_COREELEC_AMLOGIC_NOISEREDUCTION = "coreelec.amlogic.noisereduction";
+  static constexpr auto SETTING_COREELEC_AMLOGIC_SDR2HDR = "coreelec.amlogic.sdr2hdr";
   static constexpr auto SETTING_CACHE_HARDDISK = "cache.harddisk";
   static constexpr auto SETTING_CACHEVIDEO_DVDROM = "cachevideo.dvdrom";
   static constexpr auto SETTING_CACHEVIDEO_LAN = "cachevideo.lan";
diff --git a/xbmc/windowing/amlogic/WinSystemAmlogic.cpp b/xbmc/windowing/amlogic/WinSystemAmlogic.cpp
index 73bd2f818ac..3ee0f484734 100644
--- a/xbmc/windowing/amlogic/WinSystemAmlogic.cpp
+++ b/xbmc/windowing/amlogic/WinSystemAmlogic.cpp
@@ -83,6 +83,21 @@ CWinSystemAmlogic::~CWinSystemAmlogic()
 
 bool CWinSystemAmlogic::InitWindowSystem()
 {
+  const std::shared_ptr<CSettings> settings = CServiceBroker::GetSettingsComponent()->GetSettings();
+
+  if (settings->GetBool(CSettings::SETTING_COREELEC_AMLOGIC_NOISEREDUCTION))
+  {
+     CLog::Log(LOGDEBUG, "CWinSystemAmlogic::InitWindowSystem -- disabling noise reduction");
+     SysfsUtils::SetString("/sys/module/di/parameters/nr2_en", "0");
+  }
+
+  int sdr2hdr = settings->GetInt(CSettings::SETTING_COREELEC_AMLOGIC_SDR2HDR);
+  if (sdr2hdr != 0) // Default is Off (0)
+  {
+    CLog::Log(LOGDEBUG, "CWinSystemAmlogic::InitWindowSystem -- setting sdr2hdr mode to %d", sdr2hdr);
+    SysfsUtils::SetInt("/sys/module/am_vecm/parameters/sdr_mode", sdr2hdr);
+  }
+
   m_nativeDisplay = EGL_DEFAULT_DISPLAY;
 
   CDVDVideoCodecAmlogic::Register();
